name: Check Pull Request
on:
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
jobs:
  unit-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
      - name: Get pnpm store directory
        id: pnpm-cache
        run: |
          echo "pnpm_cache_dir=$(pnpm store path)" >> $GITHUB_OUTPUT
      - name: Cache pnpm modules
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.pnpm_cache_dir }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - name: Install dependencies
        run: pnpm install
      - name: Run tests with coverage
        run: pnpm --filter @trycourier/react-designer test:coverage
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: packages/react-designer/coverage/
          retention-days: 7
      - name: Coverage Summary
        run: |
          echo "## ðŸ“Š Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f packages/react-designer/coverage/coverage-summary.json ]; then
            node -e "
              const cov = require('./packages/react-designer/coverage/coverage-summary.json').total;
              console.log('| Metric | Coverage |');
              console.log('|--------|----------|');
              console.log('| Statements | ' + cov.statements.pct + '% |');
              console.log('| Branches | ' + cov.branches.pct + '% |');
              console.log('| Functions | ' + cov.functions.pct + '% |');
              console.log('| Lines | ' + cov.lines.pct + '% |');
            " >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

  e2e-test:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
      - name: Get pnpm store directory
        id: pnpm-cache
        run: |
          echo "pnpm_cache_dir=$(pnpm store path)" >> $GITHUB_OUTPUT
      - name: Cache pnpm modules
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.pnpm_cache_dir }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - name: Setup test environment
        run: |
          cd apps/editor-dev
          cp .env.test .env
          echo "âœ… Test environment configured - .env created from .env.test"
          echo "Contents of .env:"
          cat .env
      - name: Install dependencies
        run: pnpm install
      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(cd packages/react-designer && node -p "require('@playwright/test/package.json').version")" >> $GITHUB_OUTPUT
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd packages/react-designer && npx playwright install chromium --with-deps
      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: cd packages/react-designer && npx playwright install-deps chromium
      - name: Build packages
        run: pnpm --filter @trycourier/react-designer build
      - name: Verify .env exists before tests
        run: |
          echo "Checking if .env exists in apps/editor-dev:"
          ls -la apps/editor-dev/.env || echo ".env NOT FOUND!"
          if [ -f apps/editor-dev/.env ]; then
            echo "âœ… .env file exists"
            echo "Contents:"
            cat apps/editor-dev/.env
          else
            echo "âŒ .env file does NOT exist!"
            exit 1
          fi
      - name: Run e2e tests
        env:
          VITE_API_URL: "https://api.courier.com/client/q"
          VITE_TEMPLATE_ID: "test-template"
          VITE_TENANT_ID: "test-tenant"
          VITE_JWT_TOKEN: "test-token"
        run: cd packages/react-designer && pnpm test:e2e
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: packages/react-designer/playwright-report/
          retention-days: 7

  full-cycle-e2e-test:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
      - name: Get pnpm store directory
        id: pnpm-cache
        run: |
          echo "pnpm_cache_dir=$(pnpm store path)" >> $GITHUB_OUTPUT
      - name: Cache pnpm modules
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.pnpm_cache_dir }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - name: Install dependencies
        run: pnpm install
      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(cd packages/react-designer && node -p "require('@playwright/test/package.json').version")" >> $GITHUB_OUTPUT
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd packages/react-designer && npx playwright install chromium --with-deps
      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: cd packages/react-designer && npx playwright install-deps chromium
      - name: Setup editor-dev environment
        run: |
          cd apps/editor-dev
          cp .env.test .env
      - name: Build packages
        run: pnpm --filter @trycourier/react-designer build
      - name: Create .env.fullcycle from secrets
        run: |
          cat > packages/react-designer/.env.fullcycle << EOF
          COURIER_AUTH_TOKEN=${{ secrets.COURIER_AUTH_TOKEN }}
          VITE_API_URL=${{ secrets.VITE_API_URL }}
          VITE_TEMPLATE_ID=${{ secrets.VITE_TEMPLATE_ID }}
          VITE_TENANT_ID=${{ secrets.VITE_TENANT_ID }}
          VITE_JWT_TOKEN=${{ secrets.VITE_JWT_TOKEN }}
          EOF
      - name: Run full-cycle E2E tests
        id: fullcycle
        continue-on-error: true
        run: cd packages/react-designer && pnpm test:e2e:fullcycle
      - name: Visual parity step summary
        if: always()
        run: |
          REPORT="packages/react-designer/test-results/visual-parity-report.md"
          if [ -f "$REPORT" ]; then
            cat "$REPORT" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Post visual parity PR comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'packages/react-designer/test-results/visual-parity-report.md';
            if (!fs.existsSync(reportPath)) {
              console.log('No visual parity report found â€” skipping comment.');
              return;
            }
            const body = fs.readFileSync(reportPath, 'utf-8');
            const marker = '<!-- visual-parity-report -->';
            const fullBody = marker + '\n' + body;

            // Find existing comment to update (avoid duplicates)
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body?.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: fullBody,
              });
              console.log('Updated existing visual parity comment.');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: fullBody,
              });
              console.log('Created new visual parity comment.');
            }
      - name: Upload full-cycle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fullcycle-playwright-report
          path: packages/react-designer/playwright-report/
          retention-days: 7
      - name: Fail if tests failed
        if: steps.fullcycle.outcome == 'failure'
        run: exit 1